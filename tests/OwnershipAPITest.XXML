#import Language::Core;
#import Language::Reflection;
#import System;

// Test classes with different ownership patterns

[ Class <OwnedFields> Extends None
	[ Public<>
		Property <ownedInt> Types Integer^;
		Property <ownedStr> Types String^;

		Constructor Parameters () -> {
			Set ownedInt = Integer::Constructor(0);
			Set ownedStr = String::Constructor("");
		}
	]
]

[ Class <RefFields> Extends None
	[ Public<>
		Property <refInt> Types Integer&;
		Property <refStr> Types String&;
	]
]

[ Class <CopyFields> Extends None
	[ Public<>
		Property <copyInt> Types Integer%;
		Property <copyStr> Types String%;
	]
]

[ Class <MixedFields> Extends None
	[ Public<>
		Property <owned> Types Integer^;
		Property <ref> Types String&;
		Property <copy> Types Integer%;

		Constructor Parameters () -> {
			Set owned = Integer::Constructor(42);
		}
	]
]

[ Entrypoint
{
	Instantiate Integer^ As <passed> = Integer::Constructor(0);
	Instantiate Integer^ As <failed> = Integer::Constructor(0);

	Run System::Console::printLine(String::Constructor("=== Ownership API Test ==="));
	Run System::Console::printLine(String::Constructor(""));

	// ===== Test 1: Owned (^) Properties =====
	Run System::Console::printLine(String::Constructor("--- Test 1: Owned (^) Properties ---"));

	Instantiate Type^ As <ownedType> = Type::forName(String::Constructor("OwnedFields"));
	Instantiate PropertyInfo^ As <ownedIntProp> = ownedType.getProperty(String::Constructor("ownedInt"));
	Instantiate Integer^ As <own1> = ownedIntProp.getOwnership();

	Run System::Console::print(String::Constructor("OwnedFields.ownedInt ownership: "));
	Run System::Console::printLine(own1.toString());

	If (own1.toInt64() == 1) -> {
		Run System::Console::printLine(String::Constructor("PASS: Owned (^) detected as 1"));
		Set passed = Integer::Constructor(passed.toInt64() + 1);
	} Else -> {
		Run System::Console::printLine(String::Constructor("FAIL: Expected ownership 1 for Owned"));
		Set failed = Integer::Constructor(failed.toInt64() + 1);
	}

	Instantiate PropertyInfo^ As <ownedStrProp> = ownedType.getProperty(String::Constructor("ownedStr"));
	Instantiate Integer^ As <own2> = ownedStrProp.getOwnership();
	If (own2.toInt64() == 1) -> {
		Run System::Console::printLine(String::Constructor("PASS: ownedStr also has Owned ownership"));
		Set passed = Integer::Constructor(passed.toInt64() + 1);
	} Else -> {
		Run System::Console::printLine(String::Constructor("FAIL: ownedStr should have Owned ownership"));
		Set failed = Integer::Constructor(failed.toInt64() + 1);
	}

	// ===== Test 2: Reference (&) Properties =====
	Run System::Console::printLine(String::Constructor(""));
	Run System::Console::printLine(String::Constructor("--- Test 2: Reference (&) Properties ---"));

	Instantiate Type^ As <refType> = Type::forName(String::Constructor("RefFields"));
	Instantiate PropertyInfo^ As <refIntProp> = refType.getProperty(String::Constructor("refInt"));
	Instantiate Integer^ As <ref1> = refIntProp.getOwnership();

	Run System::Console::print(String::Constructor("RefFields.refInt ownership: "));
	Run System::Console::printLine(ref1.toString());

	If (ref1.toInt64() == 2) -> {
		Run System::Console::printLine(String::Constructor("PASS: Reference (&) detected as 2"));
		Set passed = Integer::Constructor(passed.toInt64() + 1);
	} Else -> {
		Run System::Console::printLine(String::Constructor("FAIL: Expected ownership 2 for Reference"));
		Set failed = Integer::Constructor(failed.toInt64() + 1);
	}

	Instantiate PropertyInfo^ As <refStrProp> = refType.getProperty(String::Constructor("refStr"));
	Instantiate Integer^ As <ref2> = refStrProp.getOwnership();
	If (ref2.toInt64() == 2) -> {
		Run System::Console::printLine(String::Constructor("PASS: refStr also has Reference ownership"));
		Set passed = Integer::Constructor(passed.toInt64() + 1);
	} Else -> {
		Run System::Console::printLine(String::Constructor("FAIL: refStr should have Reference ownership"));
		Set failed = Integer::Constructor(failed.toInt64() + 1);
	}

	// ===== Test 3: Copy (%) Properties =====
	Run System::Console::printLine(String::Constructor(""));
	Run System::Console::printLine(String::Constructor("--- Test 3: Copy (%) Properties ---"));

	Instantiate Type^ As <copyType> = Type::forName(String::Constructor("CopyFields"));
	Instantiate PropertyInfo^ As <copyIntProp> = copyType.getProperty(String::Constructor("copyInt"));
	Instantiate Integer^ As <copy1> = copyIntProp.getOwnership();

	Run System::Console::print(String::Constructor("CopyFields.copyInt ownership: "));
	Run System::Console::printLine(copy1.toString());

	If (copy1.toInt64() == 3) -> {
		Run System::Console::printLine(String::Constructor("PASS: Copy (%) detected as 3"));
		Set passed = Integer::Constructor(passed.toInt64() + 1);
	} Else -> {
		Run System::Console::printLine(String::Constructor("FAIL: Expected ownership 3 for Copy"));
		Set failed = Integer::Constructor(failed.toInt64() + 1);
	}

	Instantiate PropertyInfo^ As <copyStrProp> = copyType.getProperty(String::Constructor("copyStr"));
	Instantiate Integer^ As <copy2> = copyStrProp.getOwnership();
	If (copy2.toInt64() == 3) -> {
		Run System::Console::printLine(String::Constructor("PASS: copyStr also has Copy ownership"));
		Set passed = Integer::Constructor(passed.toInt64() + 1);
	} Else -> {
		Run System::Console::printLine(String::Constructor("FAIL: copyStr should have Copy ownership"));
		Set failed = Integer::Constructor(failed.toInt64() + 1);
	}

	// ===== Test 4: Mixed Ownership Class =====
	Run System::Console::printLine(String::Constructor(""));
	Run System::Console::printLine(String::Constructor("--- Test 4: Mixed Ownership Class ---"));

	Instantiate Type^ As <mixedType> = Type::forName(String::Constructor("MixedFields"));

	Instantiate PropertyInfo^ As <mixOwned> = mixedType.getProperty(String::Constructor("owned"));
	Instantiate Integer^ As <mixOwn1> = mixOwned.getOwnership();
	Run System::Console::print(String::Constructor("MixedFields.owned ownership: "));
	Run System::Console::printLine(mixOwn1.toString());

	If (mixOwn1.toInt64() == 1) -> {
		Run System::Console::printLine(String::Constructor("PASS: owned property is Owned"));
		Set passed = Integer::Constructor(passed.toInt64() + 1);
	} Else -> {
		Run System::Console::printLine(String::Constructor("FAIL: owned property should be Owned"));
		Set failed = Integer::Constructor(failed.toInt64() + 1);
	}

	Instantiate PropertyInfo^ As <mixRef> = mixedType.getProperty(String::Constructor("ref"));
	Instantiate Integer^ As <mixOwn2> = mixRef.getOwnership();
	Run System::Console::print(String::Constructor("MixedFields.ref ownership: "));
	Run System::Console::printLine(mixOwn2.toString());

	If (mixOwn2.toInt64() == 2) -> {
		Run System::Console::printLine(String::Constructor("PASS: ref property is Reference"));
		Set passed = Integer::Constructor(passed.toInt64() + 1);
	} Else -> {
		Run System::Console::printLine(String::Constructor("FAIL: ref property should be Reference"));
		Set failed = Integer::Constructor(failed.toInt64() + 1);
	}

	Instantiate PropertyInfo^ As <mixCopy> = mixedType.getProperty(String::Constructor("copy"));
	Instantiate Integer^ As <mixOwn3> = mixCopy.getOwnership();
	Run System::Console::print(String::Constructor("MixedFields.copy ownership: "));
	Run System::Console::printLine(mixOwn3.toString());

	If (mixOwn3.toInt64() == 3) -> {
		Run System::Console::printLine(String::Constructor("PASS: copy property is Copy"));
		Set passed = Integer::Constructor(passed.toInt64() + 1);
	} Else -> {
		Run System::Console::printLine(String::Constructor("FAIL: copy property should be Copy"));
		Set failed = Integer::Constructor(failed.toInt64() + 1);
	}

	// ===== Test 5: Type Info =====
	Run System::Console::printLine(String::Constructor(""));
	Run System::Console::printLine(String::Constructor("--- Test 5: Property Type Info ---"));

	Instantiate String^ As <ownedTypeName> = ownedIntProp.getTypeName();
	Run System::Console::print(String::Constructor("OwnedFields.ownedInt type: "));
	Run System::Console::printLine(ownedTypeName);

	Instantiate String^ As <refTypeName> = refIntProp.getTypeName();
	Run System::Console::print(String::Constructor("RefFields.refInt type: "));
	Run System::Console::printLine(refTypeName);

	Instantiate String^ As <copyTypeName> = copyIntProp.getTypeName();
	Run System::Console::print(String::Constructor("CopyFields.copyInt type: "));
	Run System::Console::printLine(copyTypeName);

	// ===== Summary =====
	Run System::Console::printLine(String::Constructor(""));
	Run System::Console::printLine(String::Constructor("================================="));
	Run System::Console::print(String::Constructor("Passed: "));
	Run System::Console::printLine(passed.toString());
	Run System::Console::print(String::Constructor("Failed: "));
	Run System::Console::printLine(failed.toString());

	If (failed.toInt64() == 0) -> {
		Run System::Console::printLine(String::Constructor("ALL OWNERSHIP API TESTS PASSED!"));
	} Else -> {
		Run System::Console::printLine(String::Constructor("SOME TESTS FAILED"));
	}

	Exit(0);
}
]
