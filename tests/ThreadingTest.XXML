#import Language::Core;
#import Concurrent;

// Threading Test - Tests atomic operations and mutex synchronization

[ Entrypoint
	{
		Run Console::printLine(String::Constructor("=== Threading Test ==="));

		// Test 1: Atomic operations
		Run Console::printLine(String::Constructor("Test 1: Atomic operations"));

		Instantiate Concurrent::Atomic^ As <counter> = Concurrent::Atomic::Constructor();
		Run counter.init(Integer::Constructor(0));

		// Test increment
		Instantiate Integer^ As <v1> = counter.increment();
		Run Console::printLine(String::Constructor("After increment: "));
		Run Console::printLine(v1.toString());

		Instantiate Integer^ As <v2> = counter.increment();
		Run Console::printLine(String::Constructor("After second increment: "));
		Run Console::printLine(v2.toString());

		// Test add
		Instantiate Integer^ As <v3> = counter.add(Integer::Constructor(10));
		Run Console::printLine(String::Constructor("After add(10): "));
		Run Console::printLine(v3.toString());

		// Test get
		Instantiate Integer^ As <v4> = counter.get();
		Run Console::printLine(String::Constructor("Current value: "));
		Run Console::printLine(v4.toString());

		// Test set
		Run counter.set(Integer::Constructor(100));
		Instantiate Integer^ As <v5> = counter.get();
		Run Console::printLine(String::Constructor("After set(100): "));
		Run Console::printLine(v5.toString());

		// Test compare and swap
		Instantiate Bool^ As <swapped> = counter.compareAndSwap(Integer::Constructor(100), Integer::Constructor(200));
		Run Console::printLine(String::Constructor("CAS(100, 200) succeeded: "));
		If (swapped == Bool::Constructor(true)) -> {
			Run Console::printLine(String::Constructor("true"));
		} Else -> {
			Run Console::printLine(String::Constructor("false"));
		}

		Instantiate Integer^ As <v6> = counter.get();
		Run Console::printLine(String::Constructor("Value after CAS: "));
		Run Console::printLine(v6.toString());

		// CAS should fail when expected doesn't match
		Instantiate Bool^ As <swapped2> = counter.compareAndSwap(Integer::Constructor(100), Integer::Constructor(300));
		Run Console::printLine(String::Constructor("CAS(100, 300) succeeded (should be false): "));
		If (swapped2 == Bool::Constructor(true)) -> {
			Run Console::printLine(String::Constructor("true"));
		} Else -> {
			Run Console::printLine(String::Constructor("false"));
		}

		Run counter.destroy();
		Run Console::printLine(String::Constructor("Atomic tests passed!"));

		// Test 2: Mutex operations
		Run Console::printLine(String::Constructor(""));
		Run Console::printLine(String::Constructor("Test 2: Mutex operations"));

		Instantiate Concurrent::Mutex^ As <mutex> = Concurrent::Mutex::Constructor();
		Instantiate Bool^ As <initOk> = mutex.init();
		Run Console::printLine(String::Constructor("Mutex init: "));
		If (initOk == Bool::Constructor(true)) -> {
			Run Console::printLine(String::Constructor("success"));
		} Else -> {
			Run Console::printLine(String::Constructor("failed"));
		}

		// Lock and unlock
		Instantiate Bool^ As <lockOk> = mutex.lock();
		Run Console::printLine(String::Constructor("Mutex lock: "));
		If (lockOk == Bool::Constructor(true)) -> {
			Run Console::printLine(String::Constructor("success"));
		} Else -> {
			Run Console::printLine(String::Constructor("failed"));
		}

		Instantiate Bool^ As <unlockOk> = mutex.unlock();
		Run Console::printLine(String::Constructor("Mutex unlock: "));
		If (unlockOk == Bool::Constructor(true)) -> {
			Run Console::printLine(String::Constructor("success"));
		} Else -> {
			Run Console::printLine(String::Constructor("failed"));
		}

		// Try lock
		Instantiate Bool^ As <tryOk> = mutex.tryLock();
		Run Console::printLine(String::Constructor("Mutex tryLock: "));
		If (tryOk == Bool::Constructor(true)) -> {
			Run Console::printLine(String::Constructor("success"));
			Run mutex.unlock();
		} Else -> {
			Run Console::printLine(String::Constructor("failed"));
		}

		Run mutex.destroy();
		Run Console::printLine(String::Constructor("Mutex tests passed!"));

		// Test 3: Thread static utilities
		Run Console::printLine(String::Constructor(""));
		Run Console::printLine(String::Constructor("Test 3: Thread utilities"));

		// Get current thread ID
		Instantiate Integer^ As <tid> = Concurrent::Thread::currentId();
		Run Console::printLine(String::Constructor("Current thread ID: "));
		Run Console::printLine(tid.toString());

		// Test sleep
		Run Console::printLine(String::Constructor("Sleeping for 100ms..."));
		Run Concurrent::Thread::sleep(Integer::Constructor(100));
		Run Console::printLine(String::Constructor("Woke up!"));

		// Test yield
		Run Console::printLine(String::Constructor("Yielding..."));
		Run Concurrent::Thread::yield();
		Run Console::printLine(String::Constructor("Continued after yield."));

		Run Console::printLine(String::Constructor(""));
		Run Console::printLine(String::Constructor("=== All Threading Tests Passed ==="));
		Exit(0);
	}
]
